<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>~/ â€¢ Private DNS</title><link href=https://gatunet.github.io/tabibito/atom.xml rel=alternate title=~/ type=application/atom+xml><link href=https://gatunet.github.io/tabibito/custom_subset.css rel=stylesheet><link href=https://gatunet.github.io/tabibito/main.css media=screen rel=stylesheet><meta content="tabi is a simple personal site and blogging theme for Zola." name=description><meta content="index, nofollow" name=robots><meta content=~/ property=og:title><meta content=article property=og:type><meta content=https://gatunet.github.io/tabibito/blog/private-dns/ property=og:url><meta content="tabi is a simple personal site and blogging theme for Zola." property=og:description><meta content=~/ property=og:site_name><meta content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;script-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com" http-equiv=Content-Security-Policy><script src=https://gatunet.github.io/tabibito/js/initialize_theme_min.js></script><script defer src=https://gatunet.github.io/tabibito/js/main_min.js></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://gatunet.github.io/tabibito>~/</a></div><div class="nav-navs socials"><ul><li><a class="nav-links no-hover-padding social" rel="noopener noreferrer" href=https://github.com/gatunet/ target=_blank> <img alt=github src=https://gatunet.github.io/tabibito/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social" rel="noopener noreferrer" href=https://hachyderm.io/@gartunius target=_blank> <img alt=mastodon src=https://gatunet.github.io/tabibito/social_icons/mastodon.svg title=mastodon> </a></ul></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://gatunet.github.io/tabibito/blog>blog</a><li><a class="nav-links no-hover-padding" href=https://gatunet.github.io/tabibito/archive>archive</a><li><a class="nav-links no-hover-padding" href=https://gatunet.github.io/tabibito/projects>projects</a><li class=theme-switcher-wrapper><div class=theme-switcher></div></ul></div></nav></header><div class=content><main><article><div class=article-title>Private DNS</div><ul class=meta><li>6th May 2023 â€¢<li title="619 words">Â 4 min read</ul><section class=body><p>Maybe the point of less privacy for people in the internet is the fact that DNS isn't encrypted ny default, so your ISP can see what you search for, even if you don't use their DNS service(you shoudn't), so how do we fix that? well, if you use Firefox and doesn't want to mess with complicated setups, you can just enable DoH(DNS over HTTPS) in the configs, you'll be limited to only a couple, but I would say that <strong>Cloudflare</strong> is pretty ok.<p>Now if you're here for the complicated(but <strong>A LOT</strong> better setup) then here we go<h2 id=dns-provider><a aria-label="Anchor link for: dns-provider" class=zola-anchor href=#dns-provider>ðŸ”—</a>DNS Provider</h2><p>The first thing you need to do is chose a provider, here are a couple of good ones:<ul><li><a href=https://www.quad9.net rel=noopener target=_blank>9.9.9.9 - Quad9</a><li><a href=https://www.cloudflare.com/en-gb/learning/dns/what-is-1.1.1.1/ rel=noopener target=_blank>1.1.1.1 - Cloudflare</a></ul><p>For me, I'm going with <strong>Quad9</strong>, because not only they're a solid option, but I think they're really serious about privacy, if you want to know more you can go to their page or <a href="https://www.youtube.com/watch?v=a2RjbvMES-0" rel=noopener target=_blank>this video</a>.<h2 id=pihole-doh-dns-over-https><a aria-label="Anchor link for: pihole-doh-dns-over-https" class=zola-anchor href=#pihole-doh-dns-over-https>ðŸ”—</a>PiHole / DoH (Dns Over Https)</h2><p>Now, this is "kind of" unecessary, but is a very nice to have in the setup, so I'm going to use it, if you don't want it, you can change the cloudflared service a bit to have it doing all the work.<p>For <strong>PiHole</strong> we're going to use the <a href=https://hub.docker.com/r/pihole/pihole rel=noopener target=_blank>pihole docker</a>, with a <em>docker-compose</em> like the one bellow, and for the DoH part we'll use a container made by cloudflare that gives us a tool for using a couple of their services, one of them is to redirect our dns queries over DoH, for all of that we'll need a <strong>docker-compose</strong> like this:<p>Also as you can see, the tools made by cloudflare can accept a lot of upstream services, not only those made by cloudflare, so if you want you can even use googles DNS there.<pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">version</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>3.8<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>

<span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">services</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>

  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">pihole</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">container_name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">pihole</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">image</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">pihole/pihole:latest</span>

    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">ports</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>53:53/tcp<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>
      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>53:53/udp<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>
      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>67:67/udp<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span> <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> Only required if you are using Pi-hole as your DHCP server
</span>      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>80:80/tcp<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>

    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">environment</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">TZ</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-single z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">'</span>America/Chicago<span class="z-punctuation z-definition z-string z-end z-yaml">'</span></span>
      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">WEBPASSWORD</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-single z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">'</span>admin<span class="z-punctuation z-definition z-string z-end z-yaml">'</span></span> <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> CHANGE LATER !!!
</span>      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">PIHOLE_DNS</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">cloudflared</span> <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> or whathever the name of your other container is
</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">volumes</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-quoted z-single z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">'</span>./etc-pihole:/etc/pihole<span class="z-punctuation z-definition z-string z-end z-yaml">'</span></span>
      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-quoted z-single z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">'</span>./etc-dnsmasq.d:/etc/dnsmasq.d<span class="z-punctuation z-definition z-string z-end z-yaml">'</span></span>

    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">cap_add</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
      <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">NET_ADMIN</span> <span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> Required if you are using Pi-hole as your DHCP server, else not needed
</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">restart</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">unless-stopped</span>

  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">cloudflared</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">container_name</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">cloudflared</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">image</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">cloudflare/cloudflared:latest</span>
    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">command</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">proxy-dns --address 0.0.0.0 --port 53 --metrics 127.0.0.1:8080 --upstream https://9.9.9.9/dns-query --upstream https://149.112.112.112/dns-query --max-upstream-conns 0</span>

    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">restart</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">unless-stopped</span>
</span></code></pre><p>About this <strong>command</strong> entry on our <em>yaml</em> file, the entrypoint for this docker image is <code>ENTRYPOINT ["cloudflared", "--no-autoupdate"]</code>, and with this we just append all those flags into this command, I tried abstracting somethings to environment variables but had no luck with it, so I'm doind the "hard" way, but feel free to try a "better" way, and if you do find, please open an issue on the repo for this blog with your solution.<p>You should have a single <strong>docker-compose</strong> with both services for the "docker dns" to work and resolve your cloudflared service name to an ip for the pihole service so they can work together.<p>And after this you should have an ip to your pihole, and you can just either change your router setting to point there for DNS, or you can change in every machine.<h2 id=references><a aria-label="Anchor link for: references" class=zola-anchor href=#references>ðŸ”—</a>References</h2><ul><li><a href=https://www.quad9.net rel=noopener target=_blank>Quad9 - DNS</a><li><a href=https://www.cloudflare.com/en-gb/learning/dns/what-is-1.1.1.1/ rel=noopener target=_blank>Cloudflare - DNS</a><li><a href="https://www.youtube.com/watch?v=a2RjbvMES-0" rel=noopener target=_blank>Youtube - DNS Privacy</a><li><a href=https://hub.docker.com/r/pihole/pihole rel=noopener target=_blank>DockerHub - PiHole container</a></ul></section></article></main></div><footer><section><div class=credits><small>Powered by <a href=https://www.getzola.org target=_blank>Zola</a> & <a href=https://github.com/welpo/tabi target=_blank>tabi</a></small></div></section></footer>